<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Поиск Квартир</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- NEW: Leaflet для карт -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- NEW: Cropper.js для редактирования изображений -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        soft: {
                            primary: '#6366f1',
                            secondary: '#8b5cf6',
                            dark: '#1e293b',
                            light: '#f8fafc',
                            gray: '#94a3b8',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444',
                            info: '#3b82f6'
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'soft-lg': '0 10px 30px rgba(0, 0, 0, 0.12)',
                        'soft-xl': '0 15px 40px rgba(0, 0, 0, 0.15)'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        // NEW: Микроанимации
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'wiggle': 'wiggle 0.3s ease-in-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '25%': { transform: 'rotate(-2deg)' },
                            '75%': { transform: 'rotate(2deg)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --tg-bg-color: var(--tg-theme-bg-color, #f8fafc);
            --tg-text-color: var(--tg-theme-text-color, #1e293b);
            --tg-hint-color: var(--tg-theme-hint-color, #94a3b8);
            --tg-link-color: var(--tg-theme-link-color, #3b82f6);
            --tg-button-color: var(--tg-theme-button-color, #6366f1);
            --tg-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg-color: var(--tg-theme-secondary-bg-color, #efeff4);
            --tg-header-bg-color: var(--tg-theme-header-bg-color, #ffffff);
            --tg-destructive-text-color: var(--tg-theme-destructive-text-color, #ef4444);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            min-height: var(--tg-viewport-stable-height, 100vh);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .safe-area {
            height: var(--tg-viewport-stable-height, 100vh);
            display: flex;
            flex-direction: column;
            position: relative;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .content-wrapper::-webkit-scrollbar {
            display: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 480px;
            height: 60px;
            background-color: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding: 0 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        body.dark .bottom-nav {
            background-color: rgba(30, 41, 59, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Оптимизированные стили для темной темы */
        body.dark { background-color: #1e293b; color: #f8fafc; }
        body.dark .soft-card { background: rgba(45, 55, 72, 0.85); border: 1px solid rgba(255, 255, 255, 0.1); color: #f8fafc; }
        body.dark .soft-input { background: rgba(55, 65, 81, 0.6); color: #f8fafc; border-color: #4b5563; }
        body.dark .soft-input::placeholder { color: #9ca3af; }
        body.dark .soft-input:focus { background: #374151; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        body.dark .text-soft-dark { color: #f8fafc; }
        body.dark .text-soft-gray { color: #d1d5db; }
        body.dark .text-soft-primary { color: var(--tg-button-color, #8b99f1); }
        body.dark .welcome-card { color: #ffffff; }
        body.dark .price-tag { color: #ffffff; background-color: rgba(0,0,0,0.7); }
        body.dark .feature-badge { color: #c7d2fe; background-color: rgba(99, 102, 241, 0.2); }
        body.dark .image-upload { border-color: #4b5563; background: rgba(71, 85, 105, 0.1); }
        body.dark .image-upload:hover { background-color: rgba(99, 102, 241, 0.15); }
        body.dark .skeleton { background-color: #334155; }
        body.dark .tooltip-text { background-color: #f8fafc; color: #1e293b; }
        body.dark .tab-btn { color: var(--tg-hint-color, #94a3b8); }
        body.dark .tab-btn:hover { background-color: rgba(99, 102, 241, 0.15); }
        body.dark .tab-btn.active { color: var(--tg-button-color, #8b99f1); }
        body.dark .tab-btn.active i { color: var(--tg-button-color, #8b99f1); }
        body.dark .toggle-label { background-color: #4b5563; }
        body.dark .listing-overlay-modal .bg-white { background-color: #1e293b; }
        body.dark .listing-overlay-modal .text-soft-dark { color: #f8fafc; }
        body.dark .listing-overlay-modal .text-soft-gray { color: #d1d5db; }
        body.dark .listing-overlay-modal .border-gray-200 { border-color: #4b5563; }
        body.dark .listing-overlay-modal .bg-gray-50 { background-color: #374151; }

        /* Общие стили компонентов */
        .text-soft-dark { color: var(--tg-text-color, #1e293b); }
        .text-soft-gray { color: var(--tg-hint-color, #94a3b8); }
        .text-soft-primary { color: var(--tg-button-color, #6366f1); }
        .soft-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .soft-btn {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .soft-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        .soft-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .soft-input {
            transition: all 0.3s ease;
            background: rgba(229, 231, 235, 0.6);
            border-radius: 12px;
            border: 1px solid transparent;
        }
        .soft-input:focus {
            background: var(--tg-secondary-bg-color, #ffffff);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            border-color: var(--tg-button-color, #6366f1);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        .tab-content.active {
            display: block;
        }
        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: var(--tg-destructive-text-color, #ef4444);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            animation: pulse-slow;
        }
        .image-upload {
            border: 2px dashed var(--tg-hint-color, #cbd5e1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(148, 163, 184, 0.05);
        }
        .image-upload:hover {
            border-color: var(--tg-button-color, #6366f1);
            background-color: rgba(99, 102, 241, 0.08);
        }
        .preview-image {
            position: relative;
            margin: 5px;
        }
        .remove-image {
            position: absolute;
            top: -7px;
            right: -7px;
            background-color: var(--tg-destructive-text-color, #ef4444);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease;
        }
        .remove-image:hover {
            background-color: #dc2626;
        }
        .apartment-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
        }
        .apartment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.08);
        }
        body.dark .apartment-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .welcome-card {
            background: linear-gradient(135deg, var(--tg-button-color, #6366f1) 0%, #8b5cf6 100%);
            color: var(--tg-button-text-color, white);
            position: relative;
            overflow: hidden;
        }
        .price-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }
        .feature-badge {
            display: inline-flex;
            align-items: center;
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--tg-button-color, #6366f1);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--tg-button-color, #6366f1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tooltip {
            position: relative;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background-color: #1e293b;
            color: white;
            text-align: center;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab-btn {
            color: var(--tg-hint-color, #94a3b8);
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            max-width: 80px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .tab-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        .tab-btn.active {
            color: var(--tg-button-color, #6366f1);
        }
        .tab-btn i {
            font-size: 20px;
            transition: all 0.3s ease;
        }
        .tab-btn.active i {
            transform: scale(1.1);
            color: var(--tg-button-color, #6366f1);
        }
        .tab-btn[data-tab="favorites-tab"].active .fa-heart {
            color: var(--tg-destructive-text-color, #ef4444);
        }
        .tab-btn span {
            font-size: 10px;
            margin-top: 4px;
            font-weight: 500;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--tg-button-color, #6366f1);
        }
        .toggle-checkbox:checked + .toggle-label::after {
            transform: translateX(100%);
        }
        .toggle-label {
            width: 44px;
            height: 24px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
            display: inline-block;
        }
        .toggle-label::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .captcha-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .captcha-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        .captcha-content {
            background: var(--tg-bg-color);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }
        .oval-btn {
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }
        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .favorite-btn i {
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .favorite-btn:hover i {
            transform: scale(1.1);
        }
        .favorite-btn.favorited .fa-heart {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--tg-destructive-text-color, #ef4444);
        }
        .listing-overlay-modal {
            display: flex;
            transition: opacity 0.3s ease-out;
        }
        .listing-overlay-modal.hidden {
            display: none;
            opacity: 0;
        }
        .listing-overlay-modal > div {
            transition: transform 0.4s ease-out;
        }
        .listing-overlay-modal.hidden > div {
            transform: translateY(20px);
        }
        /* NEW: Стили для карты */
        #map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        /* NEW: Стили для чата */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--tg-bg-color);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-message {
            max-width: 70%;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 12px;
            animation: slideUp 0.3s ease-out;
        }
        .chat-message.user {
            margin-left: auto;
            background-color: var(--tg-button-color, #6366f1);
            color: var(--tg-button-text-color, #ffffff);
        }
        .chat-message.bot {
            margin-right: auto;
            background-color: var(--tg-secondary-bg-color, #efeff4);
            color: var(--tg-text-color, #1e293b);
        }
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--tg-hint-color, #e5e7eb);
        }
        /* NEW: Стили для сравнения */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table th, .comparison-table td {
            padding: 0.75rem;
            border: 1px solid var(--tg-hint-color, #e5e7eb);
            text-align: left;
        }
        .comparison-table th {
            background-color: var(--tg-secondary-bg-color, #efeff4);
        }
        /* NEW: Стили для геймификации */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--soft-success, #10b981);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        /* NEW: Стили для фоторедактора */
        .image-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .image-editor-modal.active {
            display: flex;
        }
        .image-editor-content {
            background: var(--tg-bg-color);
            padding: 1rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        .cropper-container {
            max-height: 400px;
        }
    </style>
</head>
<body class="bg-soft-light">
    <div class="max-w-md mx-auto safe-area">
        <div class="content-wrapper">
            <!-- Главная вкладка -->
            <div id="home-tab" class="tab-content active">
                <div class="mb-6">
                    <div class="soft-card p-6 shadow-soft welcome-card" role="banner">
                        <h2 class="text-xl font-semibold text-white mb-3">Найдите идеальное жильё</h2>
                        <p class="text-white text-opacity-90 mb-4 text-sm">
                            Тысячи вариантов аренды квартир в Беларуси. Быстрый поиск и удобные фильтры.
                        </p>
                        <div class="absolute bottom-4 right-4">
                            <i class="fas fa-home text-white text-opacity-30 text-4xl"></i>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="soft-card p-6 shadow-soft">
                        <h3 class="text-lg font-semibold text-soft-dark mb-4 flex items-center">
                            <i class="fas fa-sliders-h text-soft-primary mr-2"></i>
                            Параметры поиска
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-dollar-sign text-soft-gray mr-1 text-xs"></i>
                                    Цена ($)
                                </label>
                                <div class="flex space-x-3">
                                    <div class="relative w-1/2">
                                        <input type="number" id="min-price" placeholder="от" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm pl-8" aria-label="Минимальная цена">
                                        <i class="fas fa-arrow-down text-soft-gray absolute left-3 top-3.5 text-xs"></i>
                                    </div>
                                    <div class="relative w-1/2">
                                        <input type="number" id="max-price" placeholder="до" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm pl-8" aria-label="Максимальная цена">
                                        <i class="fas fa-arrow-up text-soft-gray absolute left-3 top-3.5 text-xs"></i>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-door-open text-soft-gray mr-1 text-xs"></i>
                                    Комнаты
                                </label>
                                <div class="relative">
                                    <select id="rooms" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm appearance-none pr-8" aria-label="Количество комнат">
                                        <option value="">Любое количество</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4+">4+</option>
                                        <option value="studio">Студия</option>
                                    </select>
                                    <i class="fas fa-chevron-down text-soft-gray absolute right-3 top-3.5 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-city text-soft-gray mr-1 text-xs"></i>
                                    Город
                                </label>
                                <div class="relative">
                                    <select id="city" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm appearance-none pr-8" aria-label="Выбор города">
                                        <option value="">Все города</option>
                                        <option value="minsk">Минск</option>
                                        <option value="brest">Брест</option>
                                        <option value="vitebsk">Витебск</option>
                                        <option value="gomel">Гомель</option>
                                        <option value="grodno">Гродно</option>
                                        <option value="mogilev">Могилев</option>
                                    </select>
                                    <i class="fas fa-chevron-down text-soft-gray absolute right-3 top-3.5 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                            <!-- NEW: Сохранение фильтров -->
                            <div class="flex items-center">
                                <input type="checkbox" id="save-filter" class="toggle-checkbox hidden">
                                <label for="save-filter" class="toggle-label mr-2"></label>
                                <span class="text-sm text-soft-dark">Сохранить как подписку</span>
                            </div>
                        </div>
                        <button id="search-btn" class="soft-btn mt-6 w-full bg-gradient-to-r from-soft-primary to-soft-secondary text-white py-3 px-4 rounded-xl flex items-center justify-center font-semibold hover:shadow-lg transition-all duration-300" aria-label="Найти квартиру">
                            <i class="fas fa-search mr-2"></i> Найти квартиру
                        </button>
                    </div>
                </div>

                <div id="search-results" class="hidden mb-6">
                    <h3 class="text-lg font-semibold text-soft-dark mb-4 flex items-center">
                        <i class="fas fa-list-ul text-soft-primary mr-2"></i>
                        Результаты поиска
                    </h3>
                    <div id="results-container" class="space-y-4"></div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-soft-dark dark:text-soft-light mb-4 flex items-center">
                        <i class="fas fa-users text-soft-secondary mr-2"></i> Объявления пользователей
                    </h3>
                    <div class="grid grid-cols-1 gap-4" id="popular-container">
                        <div class="soft-card p-4 shadow-soft">
                            <div class="flex space-x-4">
                                <div class="skeleton w-20 h-20 rounded-lg"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="skeleton h-4 w-3/4 rounded"></div>
                                    <div class="skeleton h-3 w-1/2 rounded"></div>
                                    <div class="skeleton h-3 w-2/3 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Новые" -->
            <div id="new-tab" class="tab-content p-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-soft-dark flex items-center">
                        <i class="fas fa-bell text-soft-primary mr-2"></i>
                        Новые объявления
                    </h2>
                    <span id="new-badge" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden animate-bounce-slow">0</span>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-soft-dark mb-4">Объявления Kufar (Пример)</h3>
                        <div class="space-y-4" id="kufar-listings">
                            <div class="text-center py-10">
                                <div class="loading-spinner mb-3"></div>
                                <p class="text-sm text-soft-gray">Загрузка новых объявлений...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Мои объявления" -->
            <div id="user-tab" class="tab-content p-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-soft-dark flex items-center">
                        <i class="fas fa-list text-soft-primary mr-2"></i> Мои объявления
                    </h2>
                    <button id="add-listing-btn" class="soft-btn bg-soft-primary text-white py-2 px-4 rounded-xl text-sm flex items-center font-medium hover:shadow-lg transition-all duration-300" aria-label="Добавить объявление">
                        <i class="fas fa-plus mr-1 text-xs"></i> Добавить
                    </button>
                </div>

                <div id="user-listings" class="space-y-4"></div>

                <div id="add-listing-form" class="hidden mt-6">
                    <div class="soft-card p-6 shadow-soft">
                        <h3 class="text-lg font-semibold text-soft-dark mb-5 flex items-center">
                            <i class="fas fa-plus-circle text-soft-primary mr-2"></i>
                            <span id="form-title">Новое объявление</span>
                        </h3>
                        <form id="listing-form" class="space-y-4">
                            <input type="hidden" name="ad_id" value="">
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-heading text-soft-gray mr-1 text-xs"></i>
                                    Заголовок <span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="text" name="title" required class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="Напр., Уютная 1-комнатная квартира" aria-required="true">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-align-left text-soft-gray mr-1 text-xs"></i>
                                    Описание
                                </label>
                                <textarea name="description" rows="4" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="Подробно опишите ваше жилье..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-dollar-sign text-soft-gray mr-1 text-xs"></i>
                                    Цена ($) <span class="text-red-500 ml-1">*</span>
                                </label>
                                <input type="number" name="price" required class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="500" aria-required="true">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                        <i class="fas fa-door-open text-soft-gray mr-1 text-xs"></i>
                                        Комнаты <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <select name="rooms" required class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm appearance-none pr-8" aria-required="true">
                                            <option value="1">1</option>
                                            <option value="2" selected>2</option>
                                            <option value="3">3</option>
                                            <option value="4+">4+</option>
                                            <option value="studio">Студия</option>
                                        </select>
                                        <i class="fas fa-chevron-down text-soft-gray absolute right-3 top-3.5 text-xs pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                        <i class="fas fa-ruler-combined text-soft-gray mr-1 text-xs"></i>
                                        Площадь (м²)
                                    </label>
                                    <input type="number" name="area" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="45">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                        <i class="fas fa-city text-soft-gray mr-1 text-xs"></i>
                                        Город <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">
                                        <select name="city" required class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm appearance-none pr-8" aria-required="true">
                                            <option value="minsk" selected>Минск</option>
                                            <option value="brest">Брест</option>
                                            <option value="vitebsk">Витебск</option>
                                            <option value="gomel">Гомель</option>
                                            <option value="grodno">Гродно</option>
                                            <option value="mogilev">Могилев</option>
                                        </select>
                                        <i class="fas fa-chevron-down text-soft-gray absolute right-3 top-3.5 text-xs pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                        <i class="fas fa-map-marker-alt text-soft-gray mr-1 text-xs"></i>
                                        Адрес
                                    </label>
                                    <input type="text" name="address" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="ул. Ленина, 10">
                                </div>
                            </div>
                            <!-- NEW: Геолокация -->
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-map-pin text-soft-gray mr-1 text-xs"></i>
                                    Координаты (широта, долгота)
                                </label>
                                <div class="flex space-x-3">
                                    <input type="number" name="latitude" step="any" class="soft-input w-1/2 p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="Широта">
                                    <input type="number" name="longitude" step="any" class="soft-input w-1/2 p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="Долгота">
                                </div>
                                <button type="button" id="get-location-btn" class="soft-btn mt-2 bg-soft-info text-white py-2 px-4 rounded-xl text-sm flex items-center font-medium">
                                    <i class="fas fa-location-arrow mr-1"></i> Определить местоположение
                                </button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-soft-dark mb-1 flex items-center">
                                    <i class="fas fa-camera text-soft-gray mr-1 text-xs"></i>
                                    Фотографии (до 5 шт.)
                                </label>
                                <div id="image-upload" class="image-upload hover:shadow-md transition-all duration-300">
                                    <i class="fas fa-cloud-upload-alt text-soft-gray text-3xl mb-2"></i>
                                    <p class="text-soft-gray text-sm">Нажмите или перетащите фото сюда</p>
                                    <p class="text-soft-gray text-xs mt-1">Рекомендуем добавлять качественные фото</p>
                                    <input type="file" id="file-input" name="photos" accept="image/jpeg,image/png,image/webp" multiple class="hidden">
                                </div>
                                <div id="preview-container" class="flex flex-wrap mt-3 -mx-1"></div>
                                <!-- NEW: Кнопка предпросмотра -->
                                <button type="button" id="preview-ad-btn" class="soft-btn mt-2 bg-soft-secondary text-white py-2 px-4 rounded-xl text-sm flex items-center font-medium">
                                    <i class="fas fa-eye mr-1"></i> Предпросмотр объявления
                                </button>
                            </div>
                            <div class="flex space-x-3 pt-3">
                                <button type="submit" class="soft-btn flex-1 bg-gradient-to-r from-soft-primary to-soft-secondary text-white py-3 px-4 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                                    <i class="fas fa-paper-plane mr-2"></i><span id="submit-btn-text">Опубликовать</span>
                                </button>
                                <button type="button" id="cancel-btn" class="soft-btn flex-1 bg-gray-200 dark:bg-gray-600 text-soft-dark py-3 px-4 rounded-xl font-medium hover:bg-gray-300 dark:hover:bg-gray-500 transition-all duration-300">
                                    Отмена
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Избранное" -->
            <div id="favorites-tab" class="tab-content p-4">
                <h2 class="text-xl font-semibold text-soft-dark dark:text-soft-light mb-6 flex items-center">
                    <i class="fas fa-heart text-red-500 mr-2"></i>
                    Избранные объявления
                </h2>
                <div id="favorites-container" class="space-y-4">
                    <div class="text-center py-10">
                        <i class="fas fa-heart-broken text-soft-gray text-3xl mb-3"></i>
                        <p class="text-sm text-soft-gray">Вы пока ничего не добавили в избранное.</p>
                    </div>
                </div>
            </div>

            <!-- NEW: Вкладка "История" -->
            <div id="history-tab" class="tab-content p-4">
                <h2 class="text-xl font-semibold text-soft-dark dark:text-soft-light mb-6 flex items-center">
                    <i class="fas fa-history text-soft-primary mr-2"></i>
                    История просмотров
                </h2>
                <div id="history-container" class="space-y-4">
                    <div class="text-center py-10">
                        <i class="fas fa-clock text-soft-gray text-3xl mb-3"></i>
                        <p class="text-sm text-soft-gray">Вы пока ничего не просматривали.</p>
                    </div>
                </div>
            </div>

            <!-- NEW: Вкладка "Сравнение" -->
            <div id="compare-tab" class="tab-content p-4">
                <h2 class="text-xl font-semibold text-soft-dark dark:text-soft-light mb-6 flex items-center">
                    <i class="fas fa-balance-scale text-soft-primary mr-2"></i>
                    Сравнение квартир
                </h2>
                <div id="compare-container" class="space-y-4">
                    <div class="text-center py-10">
                        <i class="fas fa-balance-scale text-soft-gray text-3xl mb-3"></i>
                        <p class="text-sm text-soft-gray">Добавьте квартиры для сравнения.</p>
                    </div>
                </div>
            </div>

            <!-- NEW: Вкладка "Чат" -->
            <div id="chat-tab" class="tab-content p-4">
                <h2 class="text-xl font-semibold text-soft-dark dark:text-soft-light mb-6 flex items-center">
                    <i class="fas fa-comment-alt text-soft-primary mr-2"></i>
                    Чат-помощник
                </h2>
                <div class="chat-container soft-card p-4 shadow-soft">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-container">
                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm" placeholder="Задайте вопрос..." aria-label="Сообщение в чат">
                            <button id="chat-send-btn" class="soft-btn bg-soft-primary text-white p-3 rounded-xl flex items-center justify-center">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Вкладка "Карта" -->
            <div id="map-tab" class="tab-content p-4">
                <h2 class="text-xl font-semibold text-soft-dark dark:text-soft-light mb-6 flex items-center">
                    <i class="fas fa-map-marked-alt text-soft-primary mr-2"></i>
                    Карта объектов
                </h2>
                <div id="map-container"></div>
            </div>

            <!-- Вкладка "Профиль" -->
            <div id="profile-tab" class="tab-content p-4">
                <div class="flex items-center space-x-4 mb-8">
                    <div id="profile-photo" class="w-16 h-16 rounded-full bg-gradient-to-br from-soft-primary to-soft-secondary flex items-center justify-center overflow-hidden shadow-soft flex-shrink-0">
                        <i class="fas fa-user text-white text-3xl" id="profile-icon"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-soft-dark leading-tight" id="profile-name">Пользователь</h2>
                        <p class="text-sm text-soft-gray leading-tight" id="profile-username">@username</p>
                        <!-- NEW: Рейтинг и верификация -->
                        <div class="flex items-center mt-1">
                            <span class="text-xs text-soft-success mr-1"><i class="fas fa-star"></i> 4.8</span>
                            <span class="achievement-badge"><i class="fas fa-check-circle mr-1"></i> Верифицирован</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-soft-gray uppercase tracking-wider mb-3">Активность</h3>
                    <div class="soft-card p-4 shadow-soft">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="p-2">
                                <div class="text-xl font-bold text-soft-primary" id="profile-ad-count">0</div>
                                <div class="text-xs text-soft-gray mt-1">Объявления</div>
                            </div>
                            <div class="p-2">
                                <div class="text-xl font-bold text-soft-secondary" id="profile-fav-count">0</div>
                                <div class="text-xs text-soft-gray mt-1">Избранное</div>
                            </div>
                            <div class="p-2">
                                <div class="text-xl font-bold text-soft-warning" id="profile-msg-count">0</div>
                                <div class="text-xs text-soft-gray mt-1">Сообщения</div>
                            </div>
                        </div>
                        <!-- NEW: Просмотры -->
                        <div class="text-center mt-4">
                            <div class="text-sm text-soft-gray">Ваши объявления просмотрели: <span id="profile-view-count">0</span> раз</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-soft-gray uppercase tracking-wider mb-3">Достижения</h3>
                    <div class="soft-card p-4 shadow-soft">
                        <div class="flex flex-wrap">
                            <span class="achievement-badge mb-2"><i class="fas fa-trophy mr-1"></i> Активный пользователь</span>
                            <span class="achievement-badge mb-2"><i class="fas fa-medal mr-1"></i> Топ-арендодатель</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-soft-gray uppercase tracking-wider mb-3">Настройки</h3>
                    <div class="soft-card shadow-soft divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="flex items-center justify-between p-4">
                            <div class="flex items-center">
                                <i class="fas fa-moon text-soft-gray mr-3 w-4 text-center"></i>
                                <span class="text-sm font-medium text-soft-dark">Темная тема</span>
                            </div>
                            <div>
                                <input type="checkbox" id="theme-toggle" class="toggle-checkbox hidden">
                                <label for="theme-toggle" class="toggle-label"></label>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4">
                            <div class="flex items-center">
                                <i class="fas fa-bell text-soft-gray mr-3 w-4 text-center"></i>
                                <span class="text-sm font-medium text-soft-dark">Уведомления</span>
                            </div>
                            <div>
                                <input type="checkbox" id="notifications-toggle" class="toggle-checkbox hidden" checked>
                                <label for="notifications-toggle" class="toggle-label"></label>
                            </div>
                        </div>
                        <!-- NEW: Premium -->
                        <div class="p-4">
                            <button id="premium-btn" class="soft-btn w-full bg-gradient-to-r from-soft-success to-soft-info text-white py-2 px-4 rounded-xl text-sm font-medium hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-crown mr-2"></i> Получить Premium Lite
                            </button>
                        </div>
                        <div class="p-4">
                            <button id="share-profile-btn" class="soft-btn w-full bg-soft-primary text-white py-2 px-4 rounded-xl text-sm font-medium hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-share-alt mr-2"></i> Поделиться профилем
                            </button>
                        </div>
                        <div class="p-4">
                            <button id="logout-btn" class="soft-btn w-full bg-soft-danger text-white py-2 px-4 rounded-xl text-sm font-medium hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-sign-out-alt mr-2"></i> Выйти
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center text-xs text-soft-gray mt-8">
                    <p>Версия 1.2.0</p>
                    <p class="mt-1">© 2023-2025 Поиск Квартир</p>
                </div>
            </div>
        </div>

        <!-- Навигация -->
        <div class="bottom-nav">
            <button class="tab-btn flex flex-col items-center active" data-tab="home-tab" aria-label="Главная">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </button>
            <button class="tab-btn flex flex-col items-center relative" data-tab="new-tab" aria-label="Новые объявления">
                <i class="fas fa-bell"></i>
                <span>Новые</span>
                <span id="nav-new-badge" class="unread-badge hidden">0</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="user-tab" aria-label="Мои объявления">
                <i class="fas fa-list"></i>
                <span>Мои</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="favorites-tab" aria-label="Избранное">
                <i class="fas fa-heart"></i>
                <span>Избранное</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="history-tab" aria-label="История">
                <i class="fas fa-history"></i>
                <span>История</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="compare-tab" aria-label="Сравнение">
                <i class="fas fa-balance-scale"></i>
                <span>Сравнить</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="chat-tab" aria-label="Чат">
                <i class="fas fa-comment-alt"></i>
                <span>Чат</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="map-tab" aria-label="Карта">
                <i class="fas fa-map-marked-alt"></i>
                <span>Карта</span>
            </button>
            <button class="tab-btn flex flex-col items-center" data-tab="profile-tab" aria-label="Профиль">
                <i class="fas fa-user"></i>
                <span>Профиль</span>
            </button>
        </div>
    </div>

    <!-- Капча -->
    <div id="captcha-modal" class="captcha-modal">
        <div class="captcha-content soft-card shadow-soft-lg">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-r from-soft-primary to-soft-secondary rounded-full flex items-center justify-center">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
            </div>
            <h3 class="text-lg font-semibold text-soft-dark mb-4">Подтвердите, что вы не робот</h3>
            <p class="text-soft-gray mb-4 text-sm">Введите код с картинки, чтобы продолжить поиск.</p>
            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4 flex justify-center">
                <div class="text-center">
                    <div class="text-lg font-mono tracking-widest mb-2">3A7B9C</div>
                    <div class="text-xs text-soft-gray">Введите этот код</div>
                </div>
            </div>
            <input type="text" id="captcha-input" class="soft-input w-full p-3 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-soft-primary text-sm mb-4" placeholder="Введите код" aria-label="Код капчи">
            <div class="flex space-x-3">
                <button id="captcha-submit" class="soft-btn flex-1 bg-gradient-to-r from-soft-primary to-soft-secondary text-white py-2 px-4 rounded-xl font-medium hover:shadow-lg transition-all duration-300">
                    Подтвердить
                </button>
                <button id="captcha-cancel" class="soft-btn flex-1 bg-gray-200 dark:bg-gray-600 text-soft-dark py-2 px-4 rounded-xl font-medium hover:bg-gray-300 dark:hover:bg-gray-500 transition-all duration-300">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Модалка объявления -->
    <div id="listing-overlay-modal" class="listing-overlay-modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-[150] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-soft-dark w-full max-w-md rounded-xl shadow-soft-xl overflow-hidden animate-slide-up max-h-[90vh] flex flex-col">
            <div id="listing-overlay-content" class="overflow-y-auto p-5 flex-grow"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                <div class="flex space-x-3">
                    <!-- NEW: Кнопка чата -->
                    <button id="listing-overlay-chat-btn" class="soft-btn flex-1 bg-soft-secondary text-white py-3 px-4 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 hidden">
                        <i class="fas fa-comment mr-2"></i> Написать
                    </button>
                    <button id="listing-overlay-go-btn" class="soft-btn flex-1 bg-gradient-to-r from-soft-primary to-soft-secondary text-white py-3 px-4 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 hidden">
                        Перейти
                    </button>
                    <!-- NEW: Кнопка сравнения -->
                    <button id="listing-overlay-compare-btn" class="soft-btn flex-1 bg-soft-info text-white py-3 px-4 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-balance-scale mr-2"></i> Сравнить
                    </button>
                    <!-- NEW: Кнопка скрытия -->
                    <button id="listing-overlay-hide-btn" class="soft-btn flex-1 bg-soft-danger text-white py-3 px-4 rounded-xl font-semibold hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-eye-slash mr-2"></i> Скрыть
                    </button>
                </div>
            </div>
            <button id="listing-overlay-close-btn" type="button" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white bg-white/50 dark:bg-black/50 rounded-full w-8 h-8 flex items-center justify-center z-10" aria-label="Закрыть">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- NEW: Модалка фоторедактора -->
    <div id="image-editor-modal" class="image-editor-modal">
        <div class="image-editor-content soft-card shadow-soft-lg">
            <h3 class="text-lg font-semibold text-soft-dark mb-4">Редактировать фото</h3>
            <div id="image-editor-container" class="mb-4"></div>
            <div class="flex space-x-3">
                <button id="image-editor-save" class="soft-btn flex-1 bg-gradient-to-r from-soft-primary to-soft-secondary text-white py-2 px-4 rounded-xl font-medium hover:shadow-lg transition-all duration-300">
                    Сохранить
                </button>
                <button id="image-editor-cancel" class="soft-btn flex-1 bg-gray-200 dark:bg-gray-600 text-soft-dark py-2 px-4 rounded-xl font-medium hover:bg-gray-300 dark:hover:bg-gray-500 transition-all duration-300">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Тост -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-[200] transition-opacity duration-300 opacity-0"></div>

    <script>
        const tg = window.Telegram.WebApp;
        let userId = null;
        let captchaCode = null;
        let lastSearchFilters = null;
        let cachedListings = { kufar: [], user: [] };
        let userFavorites = [];
        let allUserAdsCache = [];
        let viewedAds = []; // NEW: История просмотров
        let hiddenAds = []; // NEW: Скрытые объявления
        let compareAds = []; // NEW: Объявления для сравнения
        let userAchievements = []; // NEW: Достижения
        let isPremium = false; // NEW: Статус премиума
        const MAX_USER_ADS_VISIBLE = 5;
        const MAX_IMAGES = isPremium ? 10 : 5; // NEW: Больше фото для премиума
        let isScrolling = false;
        let map = null; // NEW: Leaflet карта
        let cropper = null; // NEW: Cropper.js

        // NEW: Cloudinary конфигурация (замените на ваши ключи)
        const CLOUDINARY_CLOUD_NAME = 'your_cloud_name';
        const CLOUDINARY_UPLOAD_PRESET = 'your_upload_preset';

        // NEW: Telegram Bot Token (замените на ваш)
        const TELEGRAM_BOT_TOKEN = 'your_bot_token';

        // --- Инициализация ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded");
            tg.ready();
            tg.expand();
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#f8fafc';
            document.body.style.color = tg.themeParams.text_color || '#1e293b';

            if (tg.colorScheme === 'dark' || localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
                document.getElementById('theme-toggle').checked = true;
            }

            userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : Date.now();
            if (!tg.initDataUnsafe.user) {
                console.warn("User data not found. Using fallback ID.");
            }
            console.log("User ID:", userId);

            // NEW: Инициализация Telegram CloudStorage
            tg.CloudStorage.getItems(['filters', 'viewedAds', 'hiddenAds', 'compareAds', 'achievements', 'isPremium'], (err, values) => {
                if (!err) {
                    lastSearchFilters = values.filters ? JSON.parse(values.filters) : null;
                    viewedAds = values.viewedAds ? JSON.parse(values.viewedAds) : [];
                    hiddenAds = values.hiddenAds ? JSON.parse(values.hiddenAds) : [];
                    compareAds = values.compareAds ? JSON.parse(values.compareAds) : [];
                    userAchievements = values.achievements ? JSON.parse(values.achievements) : [];
                    isPremium = values.isPremium === 'true';
                }
            });

            loadProfile();
            loadUserAdsOnHome();
            loadNewListings();
            loadUserListings();
            loadInitialFavorites();
            setupEventListeners();
            startBackgroundParsing();
            initializeMap(); // NEW: Инициализация карты
            initializeChat(); // NEW: Инициализация чата

            triggerHapticFeedback('soft');
        });

        // --- Haptic Feedback ---
        function triggerHapticFeedback(style = 'soft') {
            if (tg.HapticFeedback) {
                try {
                    if (style === 'error' || style === 'warning') {
                        tg.HapticFeedback.notificationOccurred(style);
                    } else {
                        tg.HapticFeedback.impactOccurred(style);
                    }
                } catch (e) {
                    console.error('Haptic feedback error:', e);
                }
            } else if ('vibrate' in navigator) {
                const duration = style === 'soft' ? 40 : style === 'light' ? 50 : style === 'medium' ? 100 : style === 'heavy' ? 150 : 50;
                navigator.vibrate(duration);
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            console.log("Setting up event listeners");
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', handleTabClick);
            });

            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) themeToggle.addEventListener('change', handleThemeToggle);

            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) searchBtn.addEventListener('click', handleSearchClick);

            const captchaSubmit = document.getElementById('captcha-submit');
            if (captchaSubmit) captchaSubmit.addEventListener('click', handleCaptchaSubmit);
            const captchaCancel = document.getElementById('captcha-cancel');
            if (captchaCancel) captchaCancel.addEventListener('click', handleCaptchaCancel);

            const listingOverlayCloseBtn = document.getElementById('listing-overlay-close-btn');
            if (listingOverlayCloseBtn) listingOverlayCloseBtn.addEventListener('click', closeListingOverlay);
            const listingOverlayModal = document.getElementById('listing-overlay-modal');
            if (listingOverlayModal) listingOverlayModal.addEventListener('click', (event) => {
                if (event.target === listingOverlayModal) {
                    closeListingOverlay();
                }
            });

            const addListingBtn = document.getElementById('add-listing-btn');
            if (addListingBtn) addListingBtn.addEventListener('click', showAddForm);

            const userListingsContainer = document.getElementById('user-listings');
            if (userListingsContainer) {
                userListingsContainer.addEventListener('click', (e) => {
                    if (e.target && e.target.id === 'add-first-listing') {
                        showAddForm();
                    }
                    handleUserListingActions(e);
                });
            }

            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', cancelAddEditForm);

            const listingForm = document.getElementById('listing-form');
            if (listingForm) listingForm.addEventListener('submit', handleListingFormSubmit);

            const imageUploadDiv = document.getElementById('image-upload');
            const fileInput = document.getElementById('file-input');
            if (imageUploadDiv && fileInput) {
                imageUploadDiv.addEventListener('click', () => fileInput.click());
                imageUploadDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imageUploadDiv.classList.add('border-soft-primary');
                });
                imageUploadDiv.addEventListener('dragleave', () => {
                    imageUploadDiv.classList.remove('border-soft-primary');
                });
                imageUploadDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageUploadDiv.classList.remove('border-soft-primary');
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: fileInput });
                });
                fileInput.addEventListener('change', handleFileSelect);
            }

            const previewContainer = document.getElementById('preview-container');
            if (previewContainer) {
                previewContainer.addEventListener('click', handleImagePreviewActions);
            }

            // NEW: Кнопка предпросмотра объявления
            const previewAdBtn = document.getElementById('preview-ad-btn');
            if (previewAdBtn) previewAdBtn.addEventListener('click', handlePreviewAd);

            // NEW: Кнопка определения геолокации
            const getLocationBtn = document.getElementById('get-location-btn');
            if (getLocationBtn) getLocationBtn.addEventListener('click', handleGetLocation);

            // NEW: Чат
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatInput = document.getElementById('chat-input');
            if (chatSendBtn && chatInput) {
                chatSendBtn.addEventListener('click', handleChatSend);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleChatSend();
                });
            }

            // NEW: Сравнение и скрытие
            const compareBtn = document.getElementById('listing-overlay-compare-btn');
            if (compareBtn) compareBtn.addEventListener('click', handleAddToCompare);
            const hideBtn = document.getElementById('listing-overlay-hide-btn');
            if (hideBtn) hideBtn.addEventListener('click', handleHideAd);

            // NEW: Поделиться профилем
            const shareProfileBtn = document.getElementById('share-profile-btn');
            if (shareProfileBtn) shareProfileBtn.addEventListener('click', handleShareProfile);

            // NEW: Premium
            const premiumBtn = document.getElementById('premium-btn');
            if (premiumBtn) premiumBtn.addEventListener('click', handlePremiumPurchase);

            // NEW: Фоторедактор
            const imageEditorSave = document.getElementById('image-editor-save');
            const imageEditorCancel = document.getElementById('image-editor-cancel');
            if (imageEditorSave) imageEditorSave.addEventListener('click', handleImageEditorSave);
            if (imageEditorCancel) imageEditorCancel.addEventListener('click', handleImageEditorCancel);

            document.body.addEventListener('click', handleFavoriteButtonClick);

            tg.onEvent('viewportChanged', handleViewportChange);
            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('focus', handleInputFocus);
            });
            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) {
                contentWrapper.addEventListener('scroll', handleScrollForKeyboard, { passive: true });
            }
            document.body.addEventListener('touchstart', handleTouchOutsideInput, { passive: true });

            document.querySelectorAll('button, a, .image-upload, select').forEach(el => {
                if (!el.hasAttribute('data-haptic-listener')) {
                    el.addEventListener('click', () => triggerHapticFeedback('light'));
                    el.addEventListener('touchstart', () => triggerHapticFeedback('light'), { passive: true });
                    el.setAttribute('data-haptic-listener', 'true');
                }
            });
        }

        // --- Event Handlers ---
    
        function handleTabClick(event) {
            const btn = event.currentTarget;
            const tabId = btn.getAttribute('data-tab');
            if (!tabId) return;
    
            // Удаляем класс active у всех вкладок и кнопок
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(tabBtn => tabBtn.classList.remove('active'));
    
            // Активируем выбранную вкладку и кнопку
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            triggerHapticFeedback('light');
    
            // Сбрасываем форму добавления объявления при переключении вкладок
            if (tabId !== 'user-tab') {
                cancelAddEditForm();
            }
    
            // NEW: Обновляем содержимое вкладок
            if (tabId === 'favorites-tab') {
                loadFavorites();
            } else if (tabId === 'history-tab') {
                loadHistory();
            } else if (tabId === 'compare-tab') {
                loadCompare();
            } else if (tabId === 'map-tab') {
                updateMap();
            } else if (tabId === 'chat-tab') {
                scrollChatToBottom();
            }
    
            // Сбрасываем бейдж новых объявлений
            if (tabId === 'new-tab') {
                document.getElementById('nav-new-badge').classList.add('hidden');
                document.getElementById('new-badge').classList.add('hidden');
            }
        }
    
        function handleThemeToggle() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            triggerHapticFeedback('medium');
        }
    
        function handleSearchClick() {
            const filters = getSearchFilters();
            lastSearchFilters = filters;
    
            // NEW: Сохранение фильтров как подписки
            if (document.getElementById('save-filter').checked) {
                tg.CloudStorage.setItem('filters', JSON.stringify(filters), () => {
                    showToast('Фильтры сохранены как подписка!', 'success');
                    sendFilterSubscription(filters);
                });
            }
    
            // Показываем капчу после 3-х поисков (заглушка)
            if (Math.random() > 0.7) {
                showCaptcha();
            } else {
                performSearch(filters);
            }
        }
    
        function handleCaptchaSubmit() {
            const input = document.getElementById('captcha-input').value.trim();
            if (input === '3A7B9C') { // Заглушка для капчи
                document.getElementById('captcha-modal').classList.remove('active');
                performSearch(lastSearchFilters);
                triggerHapticFeedback('success');
            } else {
                showToast('Неверный код капчи', 'error');
                triggerHapticFeedback('error');
            }
        }
    
        function handleCaptchaCancel() {
            document.getElementById('captcha-modal').classList.remove('active');
            triggerHapticFeedback('light');
        }
    
        function handleFavoriteButtonClick(event) {
            const btn = event.target.closest('.favorite-btn');
            if (!btn) return;
    
            const adId = btn.dataset.adId;
            const isFavorited = userFavorites.includes(adId);
    
            if (isFavorited) {
                userFavorites = userFavorites.filter(id => id !== adId);
                btn.classList.remove('favorited');
            } else {
                userFavorites.push(adId);
                btn.classList.add('favorited');
                triggerHapticFeedback('medium');
            }
    
            // Сохраняем избранное
            tg.CloudStorage.setItem('favorites', JSON.stringify(userFavorites));
            updateFavoritesCount();
        }
    
        function handleUserListingActions(event) {
            const target = event.target;
            if (target.classList.contains('edit-btn')) {
                const adId = target.dataset.adId;
                editListing(adId);
            } else if (target.classList.contains('delete-btn')) {
                const adId = target.dataset.adId;
                deleteListing(adId);
            }
        }
    
        function handleListingFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const adId = formData.get('ad_id');
            const newAd = {
                id: adId || Date.now().toString(),
                title: formData.get('title'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                rooms: formData.get('rooms'),
                area: parseFloat(formData.get('area')) || null,
                city: formData.get('city'),
                address: formData.get('address'),
                latitude: parseFloat(formData.get('latitude')) || null,
                longitude: parseFloat(formData.get('longitude')) || null,
                photos: Array.from(document.querySelectorAll('#preview-container img')).map(img => img.src),
                userId,
                timestamp: new Date().toISOString(),
                views: adId ? (allUserAdsCache.find(ad => ad.id === adId)?.views || 0) : 0 // NEW: Сохраняем просмотры
            };
    
            // NEW: Рекомендации
            if (newAd.photos.length < 3) {
                showToast('Рекомендуем добавить больше фото для привлечения внимания.', 'warning');
            }
            if (newAd.price > calculateAveragePrice(newAd.city, newAd.rooms) * 1.2) {
                showToast('Цена выше средней на 20%. Возможно, стоит пересмотреть.', 'warning');
            }
    
            // Сохраняем объявление
            if (adId) {
                allUserAdsCache = allUserAdsCache.map(ad => (ad.id === adId ? newAd : ad));
            } else {
                allUserAdsCache.push(newAd);
                // NEW: Геймификация
                addAchievement('first_ad', 'Первое объявление');
            }
    
            tg.CloudStorage.setItem('userAds', JSON.stringify(allUserAdsCache), () => {
                showToast(adId ? 'Объявление обновлено!' : 'Объявление добавлено!', 'success');
                loadUserListings();
                cancelAddEditForm();
                // NEW: Отправляем уведомление о новом объявлении
                if (!adId) {
                    sendNewListingNotification(newAd);
                }
            });
    
            // NEW: Отложенная публикация для премиум
            if (isPremium && Math.random() > 0.5) {
                showToast('Объявление запланировано на публикацию через 1 час.', 'info');
            }
        }
    
        function handleFileSelect(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('preview-container');
            const currentImages = previewContainer.querySelectorAll('img').length;
    
            if (files.length + currentImages > MAX_IMAGES) {
                showToast(`Максимум ${MAX_IMAGES} фото. ${isPremium ? '' : 'Получите Premium для большего количества.'}`, 'error');
                return;
            }
    
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('Поддерживаются только изображения!', 'error');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Размер файла не должен превышать 5 МБ', 'error');
                    return;
                }
    
                // NEW: Загрузка в Cloudinary
                uploadToCloudinary(file).then(url => {
                    const imgContainer = document.createElement('div');
                    imgContainer.classList.add('preview-image', 'relative');
                    imgContainer.innerHTML = `
                        <img src="${url}" class="w-20 h-20 object-cover rounded-lg" alt="Превью фото">
                        <span class="remove-image">×</span>
                        <button class="edit-image-btn absolute top-1 left-1 bg-soft-primary text-white rounded-full w-6 h-6 flex items-center justify-center" title="Редактировать">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                    `;
                    previewContainer.appendChild(imgContainer);
                    triggerHapticFeedback('light');
                }).catch(err => {
                    showToast('Ошибка загрузки изображения', 'error');
                    console.error(err);
                });
            });
    
            event.target.value = ''; // Сбрасываем input
        }
    
        function handleImagePreviewActions(event) {
            if (event.target.classList.contains('remove-image')) {
                event.target.parentElement.remove();
                triggerHapticFeedback('medium');
            } else if (event.target.closest('.edit-image-btn')) {
                const img = event.target.closest('.preview-image').querySelector('img');
                openImageEditor(img.src);
            }
        }
    
        // NEW: Обработчик предпросмотра объявления
        function handlePreviewAd() {
            const form = document.getElementById('listing-form');
            const formData = new FormData(form);
            const previewAd = {
                id: 'preview',
                title: formData.get('title') || 'Предпросмотр объявления',
                description: formData.get('description') || 'Описание отсутствует',
                price: parseFloat(formData.get('price')) || 0,
                rooms: formData.get('rooms') || 'Не указано',
                area: parseFloat(formData.get('area')) || null,
                city: formData.get('city') || 'Не указано',
                address: formData.get('address') || 'Не указано',
                photos: Array.from(document.querySelectorAll('#preview-container img')).map(img => img.src),
                userId: 'preview',
                timestamp: new Date().toISOString(),
                views: 0
            };
            showListingOverlay(previewAd, true);
        }
    
        // NEW: Обработчик геолокации
        function handleGetLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.querySelector('input[name="latitude"]').value = position.coords.latitude.toFixed(6);
                        document.querySelector('input[name="longitude"]').value = position.coords.longitude.toFixed(6);
                        showToast('Местоположение определено!', 'success');
                        triggerHapticFeedback('success');
                    },
                    (error) => {
                        showToast('Не удалось определить местоположение', 'error');
                        triggerHapticFeedback('error');
                    }
                );
            } else {
                showToast('Геолокация не поддерживается', 'error');
            }
        }
    
        // NEW: Обработчик отправки сообщения в чат
        function handleChatSend() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (!message) return;
    
            addChatMessage(message, 'user');
            chatInput.value = '';
            scrollChatToBottom();
    
            // Симуляция ответа AI-ассистента
            setTimeout(() => {
                const response = getAIResponse(message);
                addChatMessage(response, 'bot');
                scrollChatToBottom();
                triggerHapticFeedback('light');
            }, 500);
        }
    
        // NEW: Обработчик добавления в сравнение
        function handleAddToCompare() {
            const adId = document.getElementById('listing-overlay-content').dataset.adId;
            if (!adId || adId === 'preview') return;
    
            if (compareAds.includes(adId)) {
                showToast('Объявление уже в сравнении', 'info');
                return;
            }
    
            if (compareAds.length >= 3) {
                showToast('Максимум 3 объявления для сравнения', 'error');
                return;
            }
    
            compareAds.push(adId);
            tg.CloudStorage.setItem('compareAds', JSON.stringify(compareAds));
            showToast('Добавлено в сравнение', 'success');
            triggerHapticFeedback('medium');
            loadCompare();
        }
    
        // NEW: Обработчик скрытия объявления
        function handleHideAd() {
            const adId = document.getElementById('listing-overlay-content').dataset.adId;
            if (!adId || adId === 'preview') return;
    
            if (!hiddenAds.includes(adId)) {
                hiddenAds.push(adId);
                tg.CloudStorage.setItem('hiddenAds', JSON.stringify(hiddenAds));
                showToast('Объявление скрыто', 'success');
                triggerHapticFeedback('medium');
                closeListingOverlay();
                // Обновляем списки
                loadUserListings();
                loadFavorites();
                loadHistory();
            }
        }
    
        // NEW: Обработчик покупки Premium
        function handlePremiumPurchase() {
            showToast('Перейдите на https://x.ai/grok для покупки Premium Lite', 'info');
            // Здесь можно интегрировать Telegram Payments API
        }
    
        // NEW: Обработчик шаринга профиля
        function handleShareProfile() {
            const profileLink = `https://t.me/your_bot?start=profile_${userId}`;
            tg.sendData(JSON.stringify({ type: 'share', url: profileLink, text: 'Мой профиль на Поиск Квартир!' }));
            showToast('Ссылка на профиль скопирована', 'success');
        }
    
        // NEW: Обработчики фоторедактора
        function handleImageEditorSave() {
            if (cropper) {
                cropper.getCroppedCanvas().toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const currentImg = document.querySelector('#image-editor-container img');
                    const previewImg = document.querySelector(`#preview-container img[src="${currentImg.src}"]`);
                    if (previewImg) {
                        previewImg.src = url;
                    }
                    closeImageEditor();
                    showToast('Фото обновлено', 'success');
                });
            }
        }
    
        function handleImageEditorCancel() {
            closeImageEditor();
        }
    
        function handleViewportChange(event) {
            const viewportHeight = event.data.stable_height || tg.viewportStableHeight;
            document.querySelector('.safe-area').style.height = `${viewportHeight}px`;
        }
    
        function handleInputFocus(event) {
            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) {
                setTimeout(() => {
                    event.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }
    
        function handleScrollForKeyboard() {
            if (isScrolling) return;
            isScrolling = true;
            setTimeout(() => { isScrolling = false; }, 100);
        }
    
        function handleTouchOutsideInput(event) {
            if (!event.target.closest('input, textarea, select')) {
                document.querySelectorAll('input, textarea, select').forEach(el => el.blur());
            }
        }
    
        // --- Helper Functions ---
    
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-[200] opacity-100 animate-slide-up bg-soft-${type} text-white`;
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-[200] transition-opacity duration-300 opacity-0';
                }, 300);
            }, 3000);
        }
    
        function showCaptcha() {
            captchaCode = '3A7B9C'; // Заглушка
            document.getElementById('captcha-modal').classList.add('active');
            document.getElementById('captcha-input').value = '';
        }
    
        function getSearchFilters() {
            return {
                minPrice: parseFloat(document.getElementById('min-price').value) || null,
                maxPrice: parseFloat(document.getElementById('max-price').value) || null,
                rooms: document.getElementById('rooms').value || null,
                city: document.getElementById('city').value || null
            };
        }
    
        function performSearch(filters) {
            const searchResults = document.getElementById('search-results');
            const resultsContainer = document.getElementById('results-container');
            searchResults.classList.remove('hidden');
            resultsContainer.innerHTML = `
                <div class="text-center py-10">
                    <div class="loading-spinner mb-3"></div>
                    <p class="text-sm text-soft-gray">Поиск...</p>
                </div>
            `;
    
            setTimeout(() => {
                const filteredListings = mockSearchListings(filters);
                resultsContainer.innerHTML = filteredListings.length
                    ? filteredListings.map(ad => generateApartmentCard(ad)).join('')
                    : '<p class="text-center text-sm text-soft-gray py-10">Ничего не найдено.</p>';
                addCardEventListeners(resultsContainer);
                scrollToResults();
            }, 1000);
        }
    
        function scrollToResults() {
            const searchResults = document.getElementById('search-results');
            searchResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    
        function mockSearchListings(filters) {
            return cachedListings.kufar.concat(allUserAdsCache).filter(ad => {
                if (hiddenAds.includes(ad.id)) return false;
                if (filters.minPrice && ad.price < filters.minPrice) return false;
                if (filters.maxPrice && ad.price > filters.maxPrice) return false;
                if (filters.rooms && ad.rooms !== filters.rooms) return false;
                if (filters.city && ad.city !== filters.city) return false;
                return true;
            });
        }
    
        function generateApartmentCard(ad, isPreview = false) {
            const isFavorited = userFavorites.includes(ad.id);
            const photos = ad.photos && ad.photos.length ? ad.photos : ['https://via.placeholder.com/150'];
            return `
                <div class="apartment-card soft-card p-4 shadow-soft" data-ad-id="${ad.id}">
                    <div class="relative mb-3">
                        <img src="${photos[0]}" alt="${ad.title}" class="w-full h-40 object-cover rounded-lg" loading="lazy">
                        <div class="price-tag">${ad.price} $</div>
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-ad-id="${ad.id}" aria-label="Добавить в избранное">
                            <i class="fas fa-heart text-white opacity-90 absolute top-2 right-2 text-lg drop-shadow"></i>
                        </button>
                    </div>
                    <h4 class="text-base font-semibold text-soft-dark truncate">${ad.title}</h4>
                    <p class="text-sm text-soft-gray mt-1 truncate">${ad.address || ad.city}</p>
                    <div class="flex items-center mt-2">
                        <span class="feature-badge"><i class="fas fa-door-open mr-1 text-xs"></i>${ad.rooms}</span>
                        ${ad.area ? `<span class="feature-badge"><i class="fas fa-ruler-combined mr-1 text-xs"></i>${ad.area} м²</span>` : ''}
                        <!-- NEW: Просмотры -->
                        <span class="feature-badge"><i class="fas fa-eye mr-1 text-xs"></i>${ad.views || 0}</span>
                    </div>
                    ${isPreview ? '<p class="text-xs text-soft-warning mt-2">Это предпросмотр объявления</p>' : ''}
                </div>
            `;
        }
    
        function addCardEventListeners(container) {
            container.querySelectorAll('.apartment-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.favorite-btn')) return;
                    const adId = card.dataset.adId;
                    const ad = cachedListings.kufar.concat(allUserAdsCache).find(a => a.id === adId);
                    if (ad) {
                        // NEW: Добавляем в историю просмотров
                        if (!viewedAds.includes(adId)) {
                            viewedAds.push(adId);
                            ad.views = (ad.views || 0) + 1;
                            tg.CloudStorage.setItem('viewedAds', JSON.stringify(viewedAds));
                            // Обновляем кэш
                            if (ad.userId === userId) {
                                allUserAdsCache = allUserAdsCache.map(a => (a.id === adId ? ad : a));
                                tg.CloudStorage.setItem('userAds', JSON.stringify(allUserAdsCache));
                            }
                        }
                        showListingOverlay(ad);
                    }
                });
            });
        }
    
        function showListingOverlay(ad, isPreview = false) {
            const content = document.getElementById('listing-overlay-content');
            const modal = document.getElementById('listing-overlay-modal');
            const photos = ad.photos && ad.photos.length ? ad.photos : ['https://via.placeholder.com/300'];
            content.dataset.adId = ad.id;
            const isOwnAd = ad.userId === userId;
            const isFavorited = userFavorites.includes(ad.id);
    
            content.innerHTML = `
                <div class="relative">
                    <div class="w-full h-56 overflow-hidden rounded-t-lg">
                        <img src="${photos[0]}" alt="${ad.title}" class="w-full h-full object-cover" loading="lazy">
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-semibold text-soft-dark">${ad.title}</h3>
                        <p class="text-sm text-soft-gray mt-1">${ad.address || ad.city}</p>
                        <div class="flex items-center mt-2">
                            <span class="text-2xl font-bold text-soft-primary">${ad.price} $</span>
                            <button class="favorite-btn ${isFavorited ? 'favorited' : ''} ml-auto" data-ad-id="${ad.id}" aria-label="Добавить в избранное">
                                <i class="fas fa-heart text-2xl ${isFavorited ? 'text-red-500' : 'text-gray-400'}"></i>
                            </button>
                        </div>
                        <div class="flex items-center mt-3 space-x-2">
                            <span class="feature-badge"><i class="fas fa-door-open mr-1 text-xs"></i>${ad.rooms}</span>
                            ${ad.area ? `<span class="feature-badge"><i class="fas fa-ruler-combined mr-1 text-xs"></i>${ad.area} м²</span>` : ''}
                            <span class="feature-badge"><i class="fas fa-eye mr-1 text-xs"></i>${ad.views || 0}</span>
                        </div>
                        <p class="text-sm text-soft-dark mt-4">${ad.description || 'Описание отсутствует'}</p>
                        <!-- NEW: Галерея фото -->
                        ${photos.length > 1 ? `
                            <div class="mt-4">
                                <h4 class="text-sm font-medium text-soft-dark mb-2">Фотографии</h4>
                                <div class="flex overflow-x-auto space-x-2 pb-2">
                                    ${photos.map(photo => `
                                        <img src="${photo}" alt="Фото квартиры" class="w-24 h-24 object-cover rounded-lg" loading="lazy">
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${isPreview ? '<p class="text-sm text-soft-warning mt-4">Это предпросмотр вашего объявления</p>' : ''}
                    </div>
                </div>
            `;
    
            // NEW: Управление кнопками
            document.getElementById('listing-overlay-chat-btn').classList.toggle('hidden', isOwnAd || isPreview);
            document.getElementById('listing-overlay-go-btn').classList.toggle('hidden', !ad.source || isPreview);
            document.getElementById('listing-overlay-compare-btn').classList.toggle('hidden', isPreview);
            document.getElementById('listing-overlay-hide-btn').classList.toggle('hidden', isPreview);
    
            modal.classList.remove('hidden');
            triggerHapticFeedback('medium');
        }
    
        function closeListingOverlay() {
            const modal = document.getElementById('listing-overlay-modal');
            modal.classList.add('hidden');
            triggerHapticFeedback('light');
        }
    
        function showAddForm() {
            document.getElementById('add-listing-form').classList.remove('hidden');
            document.getElementById('user-listings').classList.add('hidden');
            document.getElementById('listing-form').reset();
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('form-title').textContent = 'Новое объявление';
            document.getElementById('submit-btn-text').textContent = 'Опубликовать';
            scrollToTop();
        }
    
        function editListing(adId) {
            const ad = allUserAdsCache.find(ad => ad.id === adId);
            if (!ad) return;
    
            showAddForm();
            const form = document.getElementById('listing-form');
            form.querySelector('[name="ad_id"]').value = ad.id;
            form.querySelector('[name="title"]').value = ad.title;
            form.querySelector('[name="description"]').value = ad.description;
            form.querySelector('[name="price"]').value = ad.price;
            form.querySelector('[name="rooms"]').value = ad.rooms;
            form.querySelector('[name="area"]').value = ad.area || '';
            form.querySelector('[name="city"]').value = ad.city;
            form.querySelector('[name="address"]').value = ad.address || '';
            form.querySelector('[name="latitude"]').value = ad.latitude || '';
            form.querySelector('[name="longitude"]').value = ad.longitude || '';
            document.getElementById('form-title').textContent = 'Редактировать объявление';
            document.getElementById('submit-btn-text').textContent = 'Сохранить';
    
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            if (ad.photos) {
                ad.photos.forEach(photo => {
                    const imgContainer = document.createElement('div');
                    imgContainer.classList.add('preview-image', 'relative');
                    imgContainer.innerHTML = `
                        <img src="${photo}" class="w-20 h-20 object-cover rounded-lg" alt="Превью фото">
                        <span class="remove-image">×</span>
                        <button class="edit-image-btn absolute top-1 left-1 bg-soft-primary text-white rounded-full w-6 h-6 flex items-center justify-center" title="Редактировать">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                    `;
                    previewContainer.appendChild(imgContainer);
                });
            }
    
            scrollToTop();
        }
    
        function deleteListing(adId) {
            if (confirm('Удалить объявление?')) {
                allUserAdsCache = allUserAdsCache.filter(ad => ad.id !== adId);
                tg.CloudStorage.setItem('userAds', JSON.stringify(allUserAdsCache));
                loadUserListings();
                showToast('Объявление удалено', 'success');
                triggerHapticFeedback('medium');
            }
        }
    
        function cancelAddEditForm() {
            document.getElementById('add-listing-form').classList.add('hidden');
            document.getElementById('user-listings').classList.remove('hidden');
            document.getElementById('listing-form').reset();
            document.getElementById('preview-container').innerHTML = '';
            scrollToTop();
        }
    
        function scrollToTop() {
            document.querySelector('.content-wrapper').scrollTo({ top: 0, behavior: 'smooth' });
        }
    
        // NEW: Cloudinary загрузка
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw error;
            }
        }
    
        // NEW: Инициализация карты
        function initializeMap() {
            map = L.map('map-container').setView([53.9, 27.5667], 12); // Минск по умолчанию
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            updateMap();
        }
    
        function updateMap() {
            // Удаляем старые маркеры
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });
    
            // Добавляем маркеры для объявлений
            const listings = cachedListings.kufar.concat(allUserAdsCache).filter(ad => ad.latitude && ad.longitude && !hiddenAds.includes(ad.id));
            listings.forEach(ad => {
                const marker = L.marker([ad.latitude, ad.longitude]).addTo(map);
                marker.bindPopup(`
                    <b>${ad.title}</b><br>
                    ${ad.price} $<br>
                    ${ad.address || ad.city}<br>
                    <button onclick="showListingOverlayFromMap('${ad.id}')">Подробнее</button>
                `);
            });
    
            if (listings.length) {
                const bounds = L.latLngBounds(listings.map(ad => [ad.latitude, ad.longitude]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
    
        function showListingOverlayFromMap(adId) {
            const ad = cachedListings.kufar.concat(allUserAdsCache).find(a => a.id === adId);
            if (ad) showListingOverlay(ad);
        }
    
        // NEW: Инициализация чата
        function initializeChat() {
            addChatMessage('Здравствуйте! Я ваш помощник по аренде квартир. Задайте любой вопрос, например: "Как подать объявление?"', 'bot');
        }
    
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
        }
    
        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    
        function getAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            if (lowerMessage.includes('как подать объявление')) {
                return 'Чтобы подать объявление, перейдите во вкладку "Мои объявления" и нажмите "Добавить". Заполните форму, добавьте фото и опубликуйте. Рекомендую добавить не менее 3 качественных фото!';
            } else if (lowerMessage.includes('не приходят отклики')) {
                return 'Если откликов мало, попробуйте: 1) Добавить больше фото; 2) Проверить, не завышена ли цена; 3) Уточнить описание. Также Premium Lite может поднять ваше объявление в поиске!';
            } else {
                return 'Простите, я не понял вопроса. Попробуйте переформулировать или спросить, например, "Как подать объявление?"';
            }
        }
    
        // NEW: Уведомления
        function sendFilterSubscription(filters) {
            // Заглушка для отправки уведомлений через Telegram Bot API
            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    text: `Вы подписались на новые квартиры: ${JSON.stringify(filters, null, 2)}`
                })
            }).catch(err => console.error('Notification error:', err));
        }
    
        function sendNewListingNotification(ad) {
            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: userId,
                    text: `Ваше объявление "${ad.title}" успешно опубликовано!`
                })
            }).catch(err => console.error('Notification error:', err));
        }
    
        // NEW: История просмотров
        function loadHistory() {
            const historyContainer = document.getElementById('history-container');
            const ads = viewedAds
                .map(adId => cachedListings.kufar.concat(allUserAdsCache).find(ad => ad.id === adId))
                .filter(ad => ad && !hiddenAds.includes(ad.id));
            historyContainer.innerHTML = ads.length
                ? ads.map(ad => generateApartmentCard(ad)).join('')
                : '<div class="text-center py-10"><i class="fas fa-clock text-soft-gray text-3xl mb-3"></i><p class="text-sm text-soft-gray">Вы пока ничего не просматривали.</p></div>';
            addCardEventListeners(historyContainer);
        }
    
        // NEW: Сравнение
        function loadCompare() {
            const compareContainer = document.getElementById('compare-container');
            const ads = compareAds
                .map(adId => cachedListings.kufar.concat(allUserAdsCache).find(ad => ad.id === adId))
                .filter(ad => ad);
            if (!ads.length) {
                compareContainer.innerHTML = '<div class="text-center py-10"><i class="fas fa-balance-scale text-soft-gray text-3xl mb-3"></i><p class="text-sm text-soft-gray">Добавьте квартиры для сравнения.</p></div>';
                return;
            }
    
            compareContainer.innerHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Параметр</th>
                            ${ads.map(ad => `<th>${ad.title}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Цена ($)</td>${ads.map(ad => `<td>${ad.price}</td>`).join('')}</tr>
                        <tr><td>Комнаты</td>${ads.map(ad => `<td>${ad.rooms}</td>`).join('')}</tr>
                        <tr><td>Площадь (м²)</td>${ads.map(ad => `<td>${ad.area || '-'}</td>`).join('')}</tr>
                        <tr><td>Город</td>${ads.map(ad => `<td>${ad.city}</td>`).join('')}</tr>
                        <tr><td>Адрес</td>${ads.map(ad => `<td>${ad.address || '-'}</td>`).join('')}</tr>
                        <tr><td>Просмотры</td>${ads.map(ad => `<td>${ad.views || 0}</td>`).join('')}</tr>
                    </tbody>
                </table>
                <button id="clear-compare-btn" class="soft-btn w-full bg-soft-danger text-white py-2 px-4 rounded-xl mt-4">Очистить сравнение</button>
            `;
    
            document.getElementById('clear-compare-btn').addEventListener('click', () => {
                compareAds = [];
                tg.CloudStorage.setItem('compareAds', JSON.stringify(compareAds));
                loadCompare();
                showToast('Сравнение очищено', 'success');
            });
        }
    
        // NEW: Фоторедактор
        function openImageEditor(imageSrc) {
            const modal = document.getElementById('image-editor-modal');
            const container = document.getElementById('image-editor-container');
            container.innerHTML = `<img src="${imageSrc}" class="w-full">`;
            modal.classList.add('active');
    
            const img = container.querySelector('img');
            cropper = new Cropper(img, {
                aspectRatio: 4 / 3,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true
            });
        }
    
        function closeImageEditor() {
            const modal = document.getElementById('image-editor-modal');
            modal.classList.remove('active');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
    
        // NEW: Геймификация
        function addAchievement(id, title) {
            if (!userAchievements.find(a => a.id === id)) {
                userAchievements.push({ id, title, timestamp: new Date().toISOString() });
                tg.CloudStorage.setItem('achievements', JSON.stringify(userAchievements));
                showToast(`Достижение разблокировано: ${title}!`, 'success');
                updateProfileAchievements();
            }
        }
    
        function updateProfileAchievements() {
            const achievementsContainer = document.querySelector('#profile-tab .flex-wrap');
            achievementsContainer.innerHTML = userAchievements.map(a => `
                <span class="achievement-badge mb-2"><i class="fas fa-trophy mr-1"></i>${a.title}</span>
            `).join('');
        }
    
        // NEW: Расчет средней цены (заглушка)
        function calculateAveragePrice(city, rooms) {
            const basePrices = {
                minsk: { '1': 400, '2': 600, '3': 800, '4+': 1000, studio: 350 },
                brest: { '1': 300, '2': 450, '3': 600, '4+': 800, studio: 250 }
                // Добавить другие города
            };
            return basePrices[city]?.[rooms] || 500;
        }
    
        function loadProfile() {
            const user = tg.initDataUnsafe.user || {};
            document.getElementById('profile-name').textContent = user.first_name || 'Пользователь';
            document.getElementById('profile-username').textContent = user.username ? `@${user.username}` : '@user';
            if (user.photo_url) {
                document.getElementById('profile-photo').innerHTML = `<img src="${user.photo_url}" class="w-full h-full object-cover" alt="Фото профиля">`;
            }
            updateProfileStats();
            updateProfileAchievements();
        }
    
        function updateProfileStats() {
            document.getElementById('profile-ad-count').textContent = allUserAdsCache.length;
            document.getElementById('profile-fav-count').textContent = userFavorites.length;
            document.getElementById('profile-msg-count').textContent = 0; // Заглушка
            document.getElementById('profile-view-count').textContent = allUserAdsCache.reduce((sum, ad) => sum + (ad.views || 0), 0);
        }
    
        function loadUserAdsOnHome() {
            const container = document.getElementById('popular-container');
            container.innerHTML = allUserAdsCache.slice(0, MAX_USER_ADS_VISIBLE).map(ad => generateApartmentCard(ad)).join('');
            addCardEventListeners(container);
        }
    
        function loadNewListings() {
            const container = document.getElementById('kufar-listings');
            cachedListings.kufar = [
                {
                    id: 'kufar1',
                    title: 'Уютная студия в центре Минска',
                    price: 350,
                    rooms: 'studio',
                    area: 30,
                    city: 'minsk',
                    address: 'ул. Немига, 5',
                    latitude: 53.9045,
                    longitude: 27.5591,
                    photos: ['https://via.placeholder.com/300'],
                    source: 'kufar',
                    timestamp: new Date().toISOString(),
                    views: 10
                }
                // Добавить другие моковые объявления
            ];
            container.innerHTML = cachedListings.kufar
                .filter(ad => !hiddenAds.includes(ad.id))
                .map(ad => generateApartmentCard(ad)).join('');
            addCardEventListeners(container);
            updateNewBadge();
        }
    
        function loadUserListings() {
            const container = document.getElementById('user-listings');
            container.innerHTML = allUserAdsCache.length
                ? allUserAdsCache.map(ad => `
                    <div class="soft-card p-4 shadow-soft flex items-center space-x-4" data-ad-id="${ad.id}">
                        <img src="${ad.photos?.[0] || 'https://via.placeholder.com/80'}" alt="${ad.title}" class="w-20 h-20 object-cover rounded-lg">
                        <div class="flex-1">
                            <h4 class="text-base font-semibold text-soft-dark truncate">${ad.title}</h4>
                            <p class="text-sm text-soft-gray truncate">${ad.price} $</p>
                            <p class="text-xs text-soft-gray truncate">${ad.address || ad.city}</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button class="edit-btn soft-btn bg-soft-primary text-white p-2 rounded-lg" data-ad-id="${ad.id}" aria-label="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn soft-btn bg-soft-danger text-white p-2 rounded-lg" data-ad-id="${ad.id}" aria-label="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')
                : `
                    <div class="text-center py-10">
                        <i class="fas fa-home text-soft-gray text-3xl mb-3"></i>
                        <p class="text-sm text-soft-gray mb-3">У вас пока нет объявлений.</p>
                        <button id="add-first-listing" class="soft-btn bg-soft-primary text-white py-2 px-4 rounded-xl text-sm">Добавить первое объявление</button>
                    </div>
                `;
            updateProfileStats();
        }
    
        function loadInitialFavorites() {
            tg.CloudStorage.getItems(['favorites'], (err, values) => {
                if (!err && values.favorites) {
                    userFavorites = JSON.parse(values.favorites);
                    loadFavorites();
                }
            });
        }
    
        function loadFavorites() {
            const container = document.getElementById('favorites-container');
            const favorites = userFavorites
                .map(adId => cachedListings.kufar.concat(allUserAdsCache).find(ad => ad.id === adId))
                .filter(ad => ad && !hiddenAds.includes(ad.id));
            container.innerHTML = favorites.length
                ? favorites.map(ad => generateApartmentCard(ad)).join('')
                : '<div class="text-center py-10"><i class="fas fa-heart-broken text-soft-gray text-3xl mb-3"></i><p class="text-sm text-soft-gray">Вы пока ничего не добавили в избранное.</p></div>';
            addCardEventListeners(container);
            updateFavoritesCount();
        }
    
        function updateFavoritesCount() {
            document.getElementById('profile-fav-count').textContent = userFavorites.length;
        }
    
        function updateNewBadge() {
            const newCount = cachedListings.kufar.length;
            const badge = document.getElementById('nav-new-badge');
            const topBadge = document.getElementById('new-badge');
            if (newCount > 0) {
                badge.textContent = newCount;
                topBadge.textContent = newCount;
                badge.classList.remove('hidden');
                topBadge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                topBadge.classList.add('hidden');
            }
        }
    
        function startBackgroundParsing() {
            setInterval(() => {
                // Заглушка для парсинга новых объявлений
                const newListing = {
                    id: `kufar${Date.now()}`,
                    title: 'Новая квартира',
                    price: Math.floor(Math.random() * 500) + 200,
                    rooms: ['1', '2', '3', 'studio'][Math.floor(Math.random() * 4)],
                    city: 'minsk',
                    photos: ['https://via.placeholder.com/300'],
                    source: 'kufar',
                    timestamp: new Date().toISOString(),
                    views: 0
                };
                cachedListings.kufar.push(newListing);
                loadNewListings();
                // NEW: Проверка подписок
                if (lastSearchFilters && matchFilters(newListing, lastSearchFilters)) {
                    sendFilterSubscription(newListing);
                }
            }, 60000); // Каждую минуту
        }
    
        function matchFilters(ad, filters) {
            if (filters.minPrice && ad.price < filters.minPrice) return false;
            if (filters.maxPrice && ad.price > filters.maxPrice) return false;
            if (filters.rooms && ad.rooms !== filters.rooms) return false;
            if (filters.city && ad.city !== filters.city) return false;
            return true;
        }
    </script>
    </body>
    </html>
